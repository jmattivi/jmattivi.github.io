---
layout: post
title: Prevent Multiple Invocations of a Runbook
date: '2012-06-02T04:33:00.000-07:00'
author: Jon Mattivi
tags:
- edm.guid
- invoke
- filter
- scorch
- System Center Orchestrator 2012
- runbook
- guid
- GET
- PowerShell
- workflows
- database query
- Orchestrator
- Orchestrator Web Service
- xml
- orchestrator.svc
- web service
- odata
- query
modified_time: '2012-06-08T09:51:55.474-07:00'
blogger_id: tag:blogger.com,1999:blog-603465820850819373.post-8570667712199238982
blogger_orig_url: http://jmattivi.blogspot.com/2012/06/prevent-multiple-invocations-of-runbook.html
---

There are many occasions where you may want to prevent someone (or schedule) from starting (queuing up) another instance of a Runbook if it's already running.&nbsp; There are three ways I've found to accomplish thisâ€¦.using counters, the database query activity to look up a running job, and the web service.<br /><br />While using counters may be the best solution to prevent workflows from running before a prerequisite workflow completes, it's not the best solution to prevent inadvertently queuing up another runbook instance.<br /><br />The database query activity can be used in this scenario to query the PolicyInstances table to see if a specific runbook is already running.<br /><br /><br /><br /><img alt="" class="alignnone size-full wp-image-86" src="http://jmattivi.files.wordpress.com/2012/02/1.jpg?w=1000" title="1" /><br /><br />The query used would look like this.&nbsp; Note you need to use the specific Runbook name in the query.<br /><br />Select POLICIES.Name,POLICYINSTANCES.Status,POLICYINSTANCES.TimeStarted,POLICYINSTANCES.TimeEnded<br />From POLICYINSTANCES,POLICIES<br />Where (POLICIES.UniqueID = POLICYINSTANCES.PolicyID) AND TimeEnded is null AND POLICIES.Name = '0.1 Runbook B'<br /><br />Based on the query results, you can use the Link logic to either start the Runbook or send an email that the Runbook is already running and cannot start at this time.<br /><br /><img alt="" class="alignnone size-full wp-image-87" src="http://jmattivi.files.wordpress.com/2012/02/2.jpg?w=1000" title="2" /><br /><br />The .NET Script activity can be used in this scenario to query the  Jobs collection of the Web Service to see if a specific runbook is  already running.<br /><br /><img alt="" class="alignnone size-full wp-image-91" src="http://jmattivi.files.wordpress.com/2012/02/3.jpg?w=1000" title="3" /><br /><br />&nbsp;The Powershell script to query the Jobs collection is a little different than I've used in prior posts.&nbsp; Sometimes it's tedious to look up the RunbookID guid, so this way you can specify the name of the runbook without the guid.&nbsp; This is accomplished by pointing to the Jobs collection, but also expanding the runbook collection as well to grab it's associated data.&nbsp; Then you can use the filter and select statements in the odata query to filter on the name of the runbook.<br /><br />Here is the URL for the GET request.&nbsp; Note you need to specify the collection name and property name together for the collection that's expanded.<br /><br />$url = "http://scorch.domain:81/Orchestrator2012/Orchestrator.svc/Jobs()?`<span style="color: red;">$expand=Runbook</span>&amp;`$filter=(Status eq 'Running') and (<span style="color: red;">Runbook/Name eq '0.1 Runbook B'</span>)&amp;`$select=<span style="color: red;">Runbook/Name</span>,Status"<br /><br />Here is the complete script to query the web service (highlighted fields would need to be updated per your environment):<br /><br />#########################################################################################<br /><br />$user = "<span style="background-color: yellow; color: black;">domain\username</span>"<br />$pass = ConvertTo-SecureString "<span style="background-color: yellow; color: black;">password</span>" -AsPlainText -Force<br />$creds = New-Object System.Management.Automation.PsCredential($user,$pass)<br /><br />$url = "<span style="background-color: yellow; color: black;">http://scorch.domain:81</span>/Orchestrator2012/Orchestrator.svc/Jobs()?`$expand=Runbook&amp;`$filter=(Status eq 'Running') and (Runbook/Name eq '<span style="background-color: yellow; color: black;">0.1 Runbook B</span>')&amp;`$select=Runbook/Name,Status"<br />$request = [System.Net.HttpWebRequest]::Create($url)<br />$request.Credentials = $creds<br />$request.Timeout = 120000<br />$request.ContentType = "application/atom+xml,application/xml"<br />$request.Headers.Add("DataServiceVersion", "2.0;NetFx")<br />$request.Method = "GET"<br /><br />$response = $request.GetResponse()<br />$requestStream = $response.GetResponseStream()<br />$readStream=new-object System.IO.StreamReader $requestStream<br />$Output = $readStream.ReadToEnd()<br />$readStream.Close()<br />$response.Close()<br />$Output<br /><br />#########################################################################################<br /><br />Here is the output from the request when Runbook B is NOT running:<br /><br />&lt;?xml version="1.0" encoding="utf-8" standalone="yes"?&gt;<br />&lt;feed xml:base="https://scorch.domain:81/Orchestrator2012/Orchestrator.svc/" xmlns:d="http://schemas.microsof<br />t.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" xmlns="http://<br />www.w3.org/2005/Atom"&gt;<br />&lt;title type="text"&gt;Jobs&lt;/title&gt;<br />&lt;id&gt;https://scorch.domain:81/Orchestrator2012/Orchestrator.svc/Jobs&lt;/id&gt;<br />&lt;updated&gt;2012-02-19T18:59:26Z&lt;/updated&gt;<br />&lt;author&gt;<br />&lt;name /&gt;<br />&lt;/author&gt;<br />&lt;link rel="self" title="Jobs" href="Jobs" /&gt;<br />&lt;/feed&gt;<br /><br />Here is the output when Runbook B is currently running:<br /><br />&lt;?xml version="1.0" encoding="utf-8" standalone="yes"?&gt;<br />&lt;feed xml:base="https://scorch.domain:81/Orchestrator2012/Orchestrator.svc/" xmlns:d="http://schemas.microsof<br />t.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" xmlns="http://<br />www.w3.org/2005/Atom"&gt;<br />&lt;title type="text"&gt;Jobs&lt;/title&gt;<br />&lt;id&gt;https://scorch.domain:81/Orchestrator2012/Orchestrator.svc/Jobs&lt;/id&gt;<br />&lt;updated&gt;2012-02-19T19:01:19Z&lt;/updated&gt;<br />&lt;link rel="self" title="Jobs" href="Jobs" /&gt;<br />&lt;entry m:etag="W/&amp;quot;datetime'2012-02-19T19%3A00%3A53.29'&amp;quot;"&gt;<br />&lt;id&gt;https://scorch.domain:81/Orchestrator2012/Orchestrator.svc/Jobs(guid'4f104fcd-d626-421d-9f75-c8c83200<br />48e0')&lt;/id&gt;<br />&lt;title type="text"&gt;&lt;/title&gt;<br />&lt;published&gt;2012-02-19T19:00:49-05:00&lt;/published&gt;<br />&lt;updated&gt;2012-02-19T19:00:53-05:00&lt;/updated&gt;<br />&lt;author&gt;<br />&lt;name /&gt;<br />&lt;/author&gt;<br />&lt;link rel="edit" title="Job" href="Jobs(guid'4f104fcd-d626-421d-9f75-c8c8320048e0')" /&gt;<br />&lt;link rel="http://schemas.microsoft.com/ado/2007/08/dataservices/related/Runbook" type="application/atom+xml;type=e<br />ntry" title="Runbook" href="Jobs(guid'4f104fcd-d626-421d-9f75-c8c8320048e0')/Runbook"&gt;<br />&lt;m:inline&gt;<br />&lt;entry m:etag="W/&amp;quot;datetime'2012-02-19T03%3A57%3A55'&amp;quot;"&gt;<br />&lt;id&gt;https://scorch.domain:81/Orchestrator2012/Orchestrator.svc/Runbooks(guid'034d6f78-0529-4111-b31<br />7-24d75fb42493')&lt;/id&gt;<br />&lt;title type="text"&gt;0.1 Runbook B&lt;/title&gt;<br />&lt;published&gt;2012-02-19T03:57:20-05:00&lt;/published&gt;<br />&lt;updated&gt;2012-02-19T03:57:55-05:00&lt;/updated&gt;<br />&lt;author&gt;<br />&lt;name /&gt;<br />&lt;/author&gt;<br />&lt;link rel="edit" title="Runbook" href="Runbooks(guid'034d6f78-0529-4111-b317-24d75fb42493')" /&gt;<br />&lt;category term="Microsoft.SystemCenter.Orchestrator.WebService.Runbook" scheme="http://schemas.microsoft.com/<br />ado/2007/08/dataservices/scheme" /&gt;<br />&lt;content type="application/xml"&gt;<br />&lt;m:properties&gt;<br />&lt;d:Name&gt;0.1 Runbook B&lt;/d:Name&gt;<br />&lt;/m:properties&gt;<br />&lt;/content&gt;<br />&lt;/entry&gt;<br />&lt;/m:inline&gt;<br />&lt;/link&gt;<br />&lt;category term="Microsoft.SystemCenter.Orchestrator.WebService.Job" scheme="http://schemas.microsoft.com/ado/2007/0<br />8/dataservices/scheme" /&gt;<br />&lt;content type="application/xml"&gt;<br />&lt;m:properties&gt;<br /><span style="color: red;">&lt;d:Status&gt;Running&lt;/d:Status&gt;</span><br />&lt;/m:properties&gt;<br />&lt;/content&gt;<br />&lt;/entry&gt;<br />&lt;/feed&gt;<br /><br />So you can see in the output above, you can use link logic to find "<span style="color: red;">&lt;d:Status&gt;Running&lt;/d:Status&gt;</span>" in the output from the query to determine if 0.1 Runbook B can be started.<br /><br /><img alt="" class="alignnone size-full wp-image-95" src="http://jmattivi.files.wordpress.com/2012/02/4.jpg?w=1000" title="4" />